# Quick Deployment Checklist for Railway

## ‚úÖ Pre-Deployment (Complete)

- [x] Created `config.py` to parse Railway environment variables
- [x] Updated `database.py` to import config
- [x] Updated `tasks.py` to use Redis URL from config
- [x] Updated `app.py` to use secret key from config
- [x] Created comprehensive deployment documentation

## üöÄ Railway Deployment Steps

### 1. Click "Deploy" in Railway Dashboard
   - You should see "Apply 2 changes" button in the Railway UI
   - Click it to deploy your changes

### 2. Add Services to Your Project

   #### A. PostgreSQL Database
   - Click "+ New" ‚Üí "Database" ‚Üí "Add PostgreSQL"
   - No configuration needed (DATABASE_URL is auto-created)

   #### B. Redis
   - Click "+ New" ‚Üí "Database" ‚Üí "Add Redis"
   - No configuration needed (REDIS_URL is auto-created)

   #### C. Web Service (Already exists)
   - Verify start command: `gunicorn wsgi:app --workers 4 --timeout 120 --bind 0.0.0.0:$PORT`
   - Or Railway will use the Procfile/railway.json config

   #### D. Celery Worker Service
   - Click "+ New" ‚Üí "GitHub Repo" ‚Üí Select AnO repo
   - Name: `celery-worker`
   - Start command: `celery -A tasks.celery worker --loglevel=INFO`
   - Link PostgreSQL and Redis variables

   #### E. Celery Beat Service
   - Click "+ New" ‚Üí "GitHub Repo" ‚Üí Select AnO repo
   - Name: `celery-beat`
   - Start command: `celery -A tasks.celery beat --loglevel=INFO`
   - Link PostgreSQL and Redis variables

### 3. Set Environment Variables

For ALL services, add these variables:

```bash
# Required
ENVIRONMENT=PROD
SECRET_KEY=<generate with: python3 -c "import secrets; print(secrets.token_hex(32))">

# Optional but recommended
DISCORD_WEBHOOK_URL=<your-webhook-url>
SENDGRID_API_KEY=<your-sendgrid-key>
```

### 4. Deploy & Monitor

1. Railway will automatically deploy after adding services
2. Check logs for each service:
   - Web: Should show Gunicorn starting
   - Worker: Should show "celery@... ready"
   - Beat: Should show beat scheduler starting
3. Visit your Railway URL to test the app

### 5. Initialize Database (First Deploy Only)

You may need to run database initialization scripts:
```bash
# Using Railway CLI (if installed)
railway run python affo/create_db.py

# Or connect to your database and run SQL scripts manually
```

## üìã Environment Variables Reference

### Auto-Generated by Railway:
- `DATABASE_URL` - PostgreSQL connection string
- `REDIS_URL` - Redis connection string
- `PORT` - Port for web service

### You Must Set:
- `ENVIRONMENT` = `PROD`
- `SECRET_KEY` = Random secure string (64+ chars)
- `DISCORD_WEBHOOK_URL` = Your Discord webhook (optional)
- `SENDGRID_API_KEY` = Your SendGrid API key (optional)

### Legacy Variables (Auto-Parsed by config.py):
These are automatically created from DATABASE_URL - you don't need to set them:
- `PG_HOST`
- `PG_PORT`
- `PG_USER`
- `PG_PASSWORD`
- `PG_DATABASE`

## üîç Troubleshooting

### If services fail to start:
1. Check logs in Railway dashboard
2. Verify all environment variables are set
3. Ensure PostgreSQL and Redis are running
4. Check that services are linked to database/redis

### If worker tasks don't run:
1. Verify both worker AND beat services are running
2. Check Redis connection in logs
3. Verify DATABASE_URL and REDIS_URL are accessible from all services

### If you see database connection errors:
1. The `config.py` module should automatically parse DATABASE_URL
2. Check that the web/worker/beat services have access to DATABASE_URL variable
3. Look for import errors in logs

## üì¶ Files Changed

The following files were created/modified to support Railway deployment:

1. **config.py** (NEW) - Parses Railway environment variables
2. **database.py** (UPDATED) - Imports config for DATABASE_URL parsing
3. **tasks.py** (UPDATED) - Uses config.get_redis_url()
4. **app.py** (UPDATED) - Uses config.get_secret_key()
5. **RAILWAY_DEPLOYMENT.md** (NEW) - Comprehensive deployment guide
6. **QUICK_DEPLOY.md** (NEW) - This checklist

## üéØ Success Criteria

Your deployment is successful when:
- [ ] All 5 services show "Active" status in Railway
- [ ] Web service is accessible at your Railway URL
- [ ] No errors in logs for any service
- [ ] You can register/login to the game
- [ ] Background tasks are running (check celery logs)

## üìû Need Help?

- Railway Docs: https://docs.railway.app
- Railway Discord: https://discord.gg/railway
- Check the detailed guide: RAILWAY_DEPLOYMENT.md

---

**Ready to deploy? Click "Apply Changes" in Railway!** üöÄ
